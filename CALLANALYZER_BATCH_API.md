# üöÄ CallAnalyzer API - Sistema de An√°lise em Lote

## Vis√£o Geral

O CallAnalyzer API √© um sistema inteligente integrado ao NIAH! que automatiza a an√°lise de liga√ß√µes telef√¥nicas usando intelig√™ncia artificial. O sistema permite processar m√∫ltiplas liga√ß√µes simultaneamente, organizadas por cliente, campanha ou agente.

## ‚ú® Funcionalidades Principais

### üéØ An√°lise em Lote
- **Processamento Simult√¢neo**: At√© 50 arquivos por lote
- **Formatos Suportados**: MP3, WAV (m√°x 25MB cada)
- **An√°lise Inteligente**: IA avalia cada liga√ß√£o baseada em crit√©rios personaliz√°veis
- **Notifica√ß√µes em Tempo Real**: Webhooks para acompanhar progresso

### üìä M√©tricas Avan√ßadas
- **Score M√©dio Geral**: Consolida√ß√£o de todas as liga√ß√µes
- **M√©dias por Crit√©rio**: Performance detalhada por aspecto avaliado
- **Distribui√ß√£o de Scores**: Classifica√ß√£o (excelente, bom, m√©dio, ruim)
- **Ranking de Performance**: Compara√ß√£o entre clientes/agentes
- **Identifica√ß√£o de Oportunidades**: √Åreas de melhoria automaticamente detectadas

### üîÑ Processamento Ass√≠ncrono
- **Resposta Imediata**: API retorna jobId para acompanhamento
- **Processamento Sequencial**: Garante qualidade na an√°lise
- **Recupera√ß√£o de Falhas**: Sistema robusto contra erros
- **Timeouts Inteligentes**: 5min transcri√ß√£o, 3min an√°lise

## üõ†Ô∏è Endpoints da API

### POST `/api/v1/analyze-batch`
Inicia an√°lise em lote de m√∫ltiplas liga√ß√µes

**Par√¢metros:**
```javascript
// FormData
audioFiles: [File, File, ...] // Array de arquivos de √°udio
criteria: JSON.stringify({
  "Cordialidade": "Avaliar tom amig√°vel e profissional",
  "Clareza": "Verificar comunica√ß√£o clara e objetiva"
})
callbackUrl: "https://webhook.site/your-url" // Opcional
metadata_0: JSON.stringify({ name: "Cliente 1", email: "cliente1@email.com" })
campaign_0: "Black Friday 2025"
agent_0: "Maria Santos"
// ... metadata_N, campaign_N, agent_N para cada arquivo
```

**Resposta:**
```json
{
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "accepted",
  "message": "Lote aceito para processamento",
  "totalCalls": 5,
  "estimatedTimeMinutes": 5,
  "timestamp": "2025-01-20T15:30:00.000Z"
}
```

### GET `/api/v1/analyze-batch?jobId={id}`
Consulta status e progresso de um lote espec√≠fico

**Resposta:**
```json
{
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "processing", // "processing" | "completed" | "failed"
  "progress": {
    "percentage": 60,
    "current": 3,
    "total": 5
  },
  "estimatedTimeRemaining": 2,
  "totalCalls": 5,
  "completedCalls": 3,
  "failedCalls": 0,
  "partialMetrics": {
    "averageOverallScore": 8.3,
    "criteriaAverages": {
      "Cordialidade": 8.5,
      "Clareza": 8.1
    }
  },
  "calls": [
    {
      "id": "call-uuid-1",
      "filename": "ligacao1.mp3",
      "status": "completed",
      "metadata": { "name": "Cliente 1" },
      "analysis": {
        "overall_score": 8.5,
        "criteria_scores": {
          "Cordialidade": 9.0,
          "Clareza": 8.0
        },
        "summary": "Excelente atendimento..."
      }
    }
  ]
}
```

### GET `/api/v1/batch-jobs`
Lista todos os lotes de an√°lise ordenados por data

**Resposta:**
```json
{
  "jobs": [
    {
      "jobId": "550e8400-e29b-41d4-a716-446655440000",
      "status": "completed",
      "totalCalls": 5,
      "completedCalls": 5,
      "failedCalls": 0,
      "createdAt": "2025-01-20T15:30:00.000Z",
      "completedAt": "2025-01-20T15:35:00.000Z",
      "progress": {
        "percentage": 100,
        "current": 5,
        "total": 5
      }
    }
  ]
}
```

## üé£ Sistema de Webhooks

O sistema envia notifica√ß√µes em tempo real sobre o progresso:

### Eventos Dispon√≠veis

#### `job_started` - Lote Iniciado
```json
{
  "event": "job_started",
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "totalCalls": 5,
  "timestamp": "2025-01-20T15:30:00.000Z"
}
```

#### `call_started` - Liga√ß√£o Individual Iniciada
```json
{
  "event": "call_started",
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "callId": "call-uuid-1",
  "callIndex": 1,
  "totalCalls": 5,
  "metadata": { "name": "Cliente 1" },
  "filename": "ligacao1.mp3",
  "timestamp": "2025-01-20T15:30:15.000Z"
}
```

#### `call_transcription_completed` - Transcri√ß√£o Finalizada
```json
{
  "event": "call_transcription_completed",
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "callId": "call-uuid-1",
  "transcript": "Transcri√ß√£o da liga√ß√£o...",
  "timestamp": "2025-01-20T15:31:00.000Z"
}
```

#### `call_completed` - An√°lise de Liga√ß√£o Finalizada
```json
{
  "event": "call_completed",
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "callId": "call-uuid-1",
  "analysis": {
    "overall_score": 8.5,
    "criteria_scores": {
      "Cordialidade": 9.0,
      "Clareza": 8.0
    },
    "summary": "Excelente atendimento com demonstra√ß√£o clara..."
  },
  "timestamp": "2025-01-20T15:32:00.000Z"
}
```

#### `call_error` - Erro em Liga√ß√£o Espec√≠fica
```json
{
  "event": "call_error",
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "callId": "call-uuid-1",
  "error": {
    "code": "PROCESSING_FAILED",
    "message": "Erro na transcri√ß√£o: arquivo corrompido"
  },
  "timestamp": "2025-01-20T15:31:30.000Z"
}
```

#### `job_completed` - Lote Finalizado com M√©tricas
```json
{
  "event": "job_completed",
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "status": "completed",
  "totalCalls": 5,
  "completedCalls": 4,
  "failedCalls": 1,
  "metricsSummary": {
    "averageOverallScore": 8.2,
    "criteriaAverages": {
      "Cordialidade": 8.5,
      "Clareza": 7.9
    },
    "scoreDistribution": {
      "excellent": 2,
      "good": 2,
      "average": 0,
      "poor": 0
    },
    "topPerformingCriteria": [
      { "criterion": "Cordialidade", "averageScore": 8.5 }
    ],
    "clientPerformance": [
      { "clientName": "Cliente 1", "overallScore": 8.5 },
      { "clientName": "Cliente 2", "overallScore": 8.1 }
    ]
  },
  "timestamp": "2025-01-20T15:35:00.000Z"
}
```

#### `job_failed` - Falha no Processamento do Lote
```json
{
  "event": "job_failed",
  "jobId": "550e8400-e29b-41d4-a716-446655440000",
  "error": {
    "code": "BATCH_PROCESSING_FAILED",
    "message": "Erro cr√≠tico no processamento do lote"
  },
  "timestamp": "2025-01-20T15:31:00.000Z"
}
```

## üíª Interface Web

### P√°gina de An√°lise em Lote
Acesse atrav√©s do menu: **üöÄ An√°lise em Lote**

**Funcionalidades:**
- ‚úÖ Upload drag-and-drop de m√∫ltiplos arquivos
- ‚úÖ Configura√ß√£o de metadata por arquivo (nome, email, campanha, agente)
- ‚úÖ Crit√©rios de avalia√ß√£o personaliz√°veis
- ‚úÖ Configura√ß√£o de webhook para notifica√ß√µes
- ‚úÖ Monitoramento em tempo real do progresso
- ‚úÖ Visualiza√ß√£o detalhada de m√©tricas
- ‚úÖ Download de resultados

### Dashboard de Jobs
- **Lista de Jobs Ativos**: Acompanhe todos os lotes em processamento
- **Progresso Visual**: Barras de progresso em tempo real
- **Detalhes Expandidos**: Modal com informa√ß√µes completas
- **M√©tricas Consolidadas**: Visualiza√ß√£o de performance

## üìà Casos de Uso Ideais

### üè¢ Call Centers
- **Avalia√ß√£o Di√°ria**: Processar todas as liga√ß√µes do dia
- **Monitoramento de Qualidade**: Identificar padr√µes de atendimento
- **Treinamento**: Detectar oportunidades de capacita√ß√£o

### üéØ Equipes de Vendas
- **An√°lise por Campanha**: Avaliar performance de campanhas espec√≠ficas
- **Compara√ß√£o de Agentes**: Ranking de performance
- **Otimiza√ß√£o de Scripts**: Identificar abordagens mais eficazes

### üìö Treinamento e Auditoria
- **Avalia√ß√£o de Novos Atendentes**: An√°lise estruturada de performance
- **Auditoria de Conformidade**: Verifica√ß√£o de protocolos
- **Feedback Automatizado**: Relat√≥rios detalhados para coaching

## ‚öôÔ∏è Configura√ß√£o e Instala√ß√£o

### 1. Depend√™ncias
```bash
cd api-server
npm install uuid node-fetch
```

### 2. Configura√ß√£o de Ambiente
```bash
# .env
OPENAI_API_KEY=sua-chave-openai-aqui  # Para produ√ß√£o
PORT=3001
```

### 3. Iniciar Servi√ßos
```bash
# Terminal 1 - API Server
cd api-server
npm start

# Terminal 2 - Frontend
npm run dev
```

### 4. Testar Webhooks
Recomendamos usar [webhook.site](https://webhook.site) para testar notifica√ß√µes em tempo real.

## üîß Configura√ß√£o para Produ√ß√£o

### Substituir Simula√ß√£o por IA Real

**Transcri√ß√£o (OpenAI Whisper):**
```javascript
async function transcribeAudio(audioBuffer, filename) {
  const formData = new FormData();
  const blob = new Blob([audioBuffer], { type: 'audio/mpeg' });
  
  const transcription = await openai.audio.transcriptions.create({
    file: blob,
    model: 'whisper-1',
    language: 'pt'
  });
  
  return transcription.text;
}
```

**An√°lise (GPT-4o):**
```javascript
async function analyzeTranscription(transcript, criteria, metadata, campaign, agent) {
  const completion = await openai.chat.completions.create({
    model: 'gpt-4o',
    messages: [{ role: 'user', content: prompt }],
    temperature: 0.3,
    max_tokens: 2000
  });
  
  return JSON.parse(completion.choices[0].message.content);
}
```

### Armazenamento Persistente
Substitua `Map()` por Redis ou banco de dados para jobs:

```javascript
// Redis example
import Redis from 'redis';
const redis = Redis.createClient();

// Salvar job
await redis.hset(`job:${jobId}`, job);

// Recuperar job
const job = await redis.hgetall(`job:${jobId}`);
```

## üìä M√©tricas e Monitoramento

### KPIs Calculados
- **Taxa de Sucesso**: % de liga√ß√µes processadas com sucesso
- **Tempo M√©dio de Processamento**: Dura√ß√£o m√©dia por liga√ß√£o
- **Distribui√ß√£o de Scores**: Classifica√ß√£o de qualidade
- **Performance por Crit√©rio**: Identifica√ß√£o de pontos fortes/fracos
- **Ranking de Agentes/Clientes**: Compara√ß√£o de performance

### Alertas Recomendados
- Taxa de falhas > 10%
- Tempo de processamento > 5min por liga√ß√£o
- Score m√©dio < 6.0
- Erros cr√≠ticos no sistema

## üö® Tratamento de Erros

### C√≥digos de Erro
- `MISSING_FILES`: Nenhum arquivo fornecido
- `TOO_MANY_FILES`: Mais de 50 arquivos
- `FILE_TOO_LARGE`: Arquivo > 25MB
- `FILE_TOO_SMALL`: Arquivo < 1KB
- `INVALID_CRITERIA`: JSON de crit√©rios inv√°lido
- `PROCESSING_FAILED`: Erro no processamento da liga√ß√£o
- `BATCH_PROCESSING_FAILED`: Erro cr√≠tico no lote

### Recupera√ß√£o Autom√°tica
- Timeout autom√°tico em transcri√ß√µes/an√°lises
- Continua√ß√£o do processamento mesmo com falhas individuais
- Log detalhado de erros para debugging

## üìù Exemplos de Uso

### Exemplo JavaScript - Frontend
```javascript
// Upload de lote
const formData = new FormData();
formData.append('criteria', JSON.stringify({
  'Cordialidade': 'Avaliar tom amig√°vel',
  'Clareza': 'Verificar comunica√ß√£o clara'
}));

files.forEach((file, index) => {
  formData.append('audioFiles', file);
  formData.append(`metadata_${index}`, JSON.stringify({
    name: 'Cliente ' + (index + 1),
    email: `cliente${index + 1}@email.com`
  }));
});

const response = await fetch('/api/v1/analyze-batch', {
  method: 'POST',
  body: formData
});

const result = await response.json();
console.log('Job ID:', result.jobId);

// Monitorar progresso
const checkProgress = async () => {
  const response = await fetch(`/api/v1/analyze-batch?jobId=${result.jobId}`);
  const status = await response.json();
  console.log('Progresso:', status.progress.percentage + '%');
};
```

### Exemplo cURL
```bash
# Iniciar an√°lise em lote
curl -X POST http://localhost:3001/api/v1/analyze-batch \
  -F "audioFiles=@ligacao1.mp3" \
  -F "audioFiles=@ligacao2.mp3" \
  -F 'criteria={"Cordialidade":"Avaliar tom amig√°vel"}' \
  -F 'metadata_0={"name":"Cliente 1"}' \
  -F 'metadata_1={"name":"Cliente 2"}'

# Consultar status
curl "http://localhost:3001/api/v1/analyze-batch?jobId=550e8400-e29b-41d4-a716-446655440000"
```

## üéâ Resultados

O sistema CallAnalyzer transforma o processo manual de avalia√ß√£o de liga√ß√µes em um pipeline automatizado e inteligente, fornecendo:

- **Insights Valiosos**: M√©tricas detalhadas sobre qualidade do atendimento
- **Efici√™ncia Operacional**: Redu√ß√£o dr√°stica no tempo de an√°lise
- **Consist√™ncia**: Avalia√ß√£o padronizada e imparcial
- **Escalabilidade**: Capacidade de processar grandes volumes
- **Visibilidade**: Dashboards e relat√≥rios em tempo real

---

*Desenvolvido pela equipe NIAH! - Transformando atendimento com intelig√™ncia artificial* üöÄ 